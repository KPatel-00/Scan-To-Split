# 15. Core Algorithms & Logic

This document details the complex "backend-like" logic that runs entirely on the client side. This includes the financial settlement engine, the PDF generation pipeline, and the storage health system.

---

## 1. The Settlement Engine
**File:** `src/lib/settlementEnhanced.ts`

This is the financial heart of the application. It takes raw items and participants and calculates exactly who owes what, handling complex German-specific edge cases.

### The Algorithm
The `calculateSplitsWithSpecialLines` function follows this strict order of operations:

1.  **Segregation:**
    *   Items are split into **Regular Items** (Burgers, Beer) and **Special Lines** (Tax, Pfand, Tips).
    *   Special Lines are identified by their Category ID (e.g., `TAX`, `DEPO`, `DISC`).

2.  **Subtotal Calculation:**
    *   Sum of all *Regular Items* only.

3.  **Base Split Calculation:**
    *   For each participant, calculate their share of Regular Items.
    *   *Logic:* `Item Price * Quantity / Assigned Users`.

4.  **Discount Application (Proportional):**
    *   Discounts (`DISC`) are applied **proportionally** to spend.
    *   *Formula:* `User Discount = User Share * (Total Discount / Subtotal)`.
    *   *Why:* If Alice spent $90 and Bob spent $10, Alice gets 90% of the $10 coupon.

5.  **Surcharges (Equal Split):**
    *   Tips (`TIP`) and Fees (`FEES`) are split **equally** among all participants.
    *   *Formula:* `User Tip = Total Tip / Total Participants`.

6.  **Deposit Handling (Pfand):**
    *   Deposits (`DEPO`) and Returns (`DEPO_RET`) are tracked separately from the main balance to ensure transparency, but added to the final Grand Total.

### Output Data Structure
```typescript
interface SplitCalculation {
  participantSplits: Record<string, number>; // The final amount each person owes
  specialLines: {
    tax: number;
    deposits: number;
    discounts: number;
    tips: number;
    fees: number;
  };
  totals: {
    subtotal: number;
    grandTotal: number; // The final bill total (must match receipt)
  };
}
```

---

## 2. PDF Generation Pipeline
**File:** `src/lib/pdf/`

The app generates professional-grade PDF reports entirely in the browser using `jspdf`.

### Architecture
*   **Lazy Loading:** The `jspdf` library (heavy) is only loaded when the user clicks "Download PDF".
*   **Generator Pattern:** The PDF is built by distinct generator functions, ensuring modularity.

### The Generators
1.  **Header (`headerGenerator.ts`):** Draws the logo, store name, date, and "Original Receipt" link.
2.  **Summary (`summaryGenerator.ts`):** Creates a high-level box showing Total, Tip, and Tax.
3.  **Participants (`participantsGenerator.ts`):** Renders a 2-column grid of participant cards, showing their avatar, name, and total owed.
4.  **Items (`itemsGenerator.ts`):** Draws the detailed itemized list table.
5.  **Footer (`footerGenerator.ts`):** Adds page numbers and the "Generated by ScanToSplit.ai" watermark.

### Layout Constants
*   **Format:** A4
*   **Units:** Millimeters (mm)
*   **Margins:** 15mm
*   **Fonts:** Helvetica (Standard PDF font)

---

## 3. Storage Health System
**File:** `src/lib/storage/`

Since we rely on `localStorage`, we implement a robust health check system to prevent data loss.

### Quota Management (`quota.ts`)
*   **Calculation:** We approximate the storage usage by measuring the string length of the serialized JSON.
*   **Limits:**
    *   **Warning:** 4MB
    *   **Critical:** 4.8MB (Browser limit is usually 5MB)
*   **Action:** If critical, the app prevents new image uploads.

### Corruption Detection (`corruption.ts`)
*   **Checksums:** Every time data is saved, we generate a simple checksum (hash).
*   **Validation:** On load, we verify the checksum. If it mismatches, we flag the data as potentially corrupted and warn the user (or attempt migration).

---

## 4. Image Compression Pipeline
**File:** `src/lib/imageCompression.ts`

To keep the app fast and storage light, no raw images are ever stored.

1.  **Input:** Raw file from camera/upload (>5MB).
2.  **Processing:** `browser-image-compression` library.
3.  **Settings:**
    *   `maxSizeMB`: 0.5 (500KB)
    *   `maxWidthOrHeight`: 1920px
4.  **Output:** Compressed Blob.
5.  **Storage:** Converted to Base64 for `localStorage` (only if small enough) or kept in memory for the session.
